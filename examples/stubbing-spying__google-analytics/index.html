<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Stubbing Google Analytics</title>
  </head>
  <body>
    <h1>My Application</h1>
    <ul>
      <li><a href="#page2" />#page2</a></li>
      <li><a href="#page3" />#page3</a></li>
    </ul>
    <br/>
    <button id="register">Register</button>

    <script>
      // lightweight local GA shim that sends expected GET pixel requests
      ;(function (w) {
        if (!w.ga) {
          let currentPage = ''
          function sendCollect (params) {
            const u = new URL('https://www.google-analytics.com/collect')
            Object.keys(params).forEach((k) => {
              if (params[k] != null && params[k] !== '') {
                u.searchParams.set(k, params[k])
              }
            })
            // trigger GET request similar to analytics.js pixel
            new Image().src = u.toString()
          }

          w.ga = function () {
            const args = Array.prototype.slice.call(arguments)
            const cmd = args[0]
            if (cmd === 'create') {
              // no-op in shim
              return
            }
            if (cmd === 'set') {
              // e.g. ga('set', 'page', 'index.html')
              if (args[1] === 'page') {
                currentPage = args[2] || ''
              }
              return
            }
            if (cmd === 'send') {
              const payload = args[1]
              if (typeof payload === 'string' && payload === 'pageview') {
                const page = args[2] || currentPage || ''
                sendCollect({ t: 'pageview', dp: page })
                return
              }
              if (payload && typeof payload === 'object' && payload.hitType === 'event') {
                sendCollect({
                  ec: payload.eventCategory,
                  ea: payload.eventAction,
                  el: payload.eventLabel,
                })
                return
              }
            }
          }
        }
      })(window)

      ga('create', 'UA-XXXXX-Y', 'auto');
      ga('set', 'page', 'index.html');
      ga('send', 'pageview');

      window.onhashchange = function () {
        // an example of calling into GA whenever there is a
        // hashchange. this is used for demonstration purposes
        ga('send', 'pageview', window.location.hash)
      }

      document.getElementById('register').addEventListener('click', (e) => {
        e.preventDefault()
        ga('send', {
          hitType: 'event',
          eventCategory: 'button',
          eventAction: 'click',
          eventLabel: 'Register'
        })
      })
    </script>
  </body>
</html>
